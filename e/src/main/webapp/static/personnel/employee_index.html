<div  id="employee_container">
	<div class="row">
		<div class="col-xs-12">
		
			<div class="widget-box  ui-sortable-handle">
				<div class="widget-header"><a href="#" ><span  onclick="$('#employeeSearchBtn',$('#employee_container')).click()" class="ace-icon fa fa-search icon-on-right bigger-110"></span></a>
					<h5 class="widget-title" i18n="search_condition"></h5>

					<div class="widget-toolbar">
						<a href="#" data-action="collapse">
							<i class="1 ace-icon fa bigger-125 fa-chevron-up"></i>
						</a>
					</div>

				</div>

				<div class="widget-body" style="display: block;">
					<div class="widget-main">
					
						<div class="row">
						       <div class="col-xs-12 col-sm-4 " style="padding-bottom: 2px">
						        <input type="text" id="employeeQueryParam_employeeNo" i18n="personnel.emp.employeeNo" placeholder ="员工编号" class="form-control search-query" >
					           </div>
					           <div class="col-xs-12 col-sm-6 ">
							    <div id="employeeSearchDiv" class="input-group col-xs-12  col-sm-6  " style="padding-bottom: 2px">
									<input type="text" id="employeeQueryParam_name"  i18n="personnel.emp.name"  placeholder ="姓名" class="form-control search-query" >
									<span class="input-group-btn">
										<button id="employeeSearchBtn" type="button" class="btn btn-purple btn-sm">
											<span class="ace-icon fa fa-search icon-on-right bigger-110"></span>
											<span i18n="find"></span>
										</button>
									</span>
				              </div>
				              </div>
				         </div>     
			              
					</div>
				</div>
			</div>
							    
			
			<table id="employee_grid-table"></table>

			<div id="employee_grid-pager"></div>

		</div>
		<!-- /.col -->
	</div>
	<!-- /.row -->
	
	
	<div id="employeeModalDiv" class="modal fade" tabindex="-1" data-backdrop="static">
		<div class="modal-dialog modal-lg" >
				<div class="modal-content">
					<div class="modal-header no-padding">
						<div class="table-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
								<span class="white">&times;</span>
							</button>
							<span i18n="personnel.emp.employeeEdit"></span>
						</div>
					</div>
					<div class="modal-body" style="max-height: 450px;overflow-y: scroll;">
						<div id="modal-tip" class="red clearfix"></div>
						<div class="widget-box">
							<div class="widget-body">
								<div id=""  class="widget-main padding-8">
									<form id="employeeForm">
									    <input id="id"  type="hidden" name="id" value=""/>	
										<div class="row">
											 <div class="col-sm-3">
										        <span class="profile-picture">
													<img id="avatar" class="editable img-responsive" src="static/component/assets/avatars/profile-pic.jpg" />
												</span>
										     </div>
										     <div class="col-sm-8" >
										        <div class="row"  style="padding-bottom: 2px">
											         <div class="form-group">
								                          <label class="col-sm-3 control-label"  i18n="personnel.emp.name"></label>
								                          <div class="col-sm-6">
								                             <input class="form-control" id="name"  name="name" type="text" />
								                          </div>
								                     </div>
										        </div>
											   <div class="row" style="padding-bottom: 2px">
											         <div class="form-group">
								                          <label class="col-sm-3 control-label"  i18n="personnel.emp.email"></label>
								                          <div class="col-sm-6">
								                             <input class="form-control" id="email"  name="email" type="text" />
								                          </div>
								                     </div>
										        </div>
										        <div class="row" style="padding-bottom: 2px">
											         <div class="form-group">
								                          <label class="col-sm-3 control-label" i18n="personnel.emp.phone"></label>
								                          <div class="col-sm-6">
								                             <input class="form-control" type="text" id="phone" name="phone" />
								                          </div>
								                     </div>
										        </div>
										        
										        <div class="row" style="padding-bottom: 2px">
											         <div class="form-group">
								                          <label class="col-sm-3 control-label" i18n="personnel.emp.sex"></label>
								                          <div class="col-sm-6">
								                             <select class="form-control"  id="sex"   name="sex" >
									                             <option value="MALE">男</option>
									                             <option value="FEMALE">女</option>
								                             </select>
								                          </div>
								                     </div>
										        </div> 
										        <div class="row" style="padding-bottom: 2px">
											         <div class="form-group">
								                          <label class="col-sm-3 control-label" i18n="personnel.emp.dob"></label>
								                           <div class="col-sm-6">
									                          <div class="input-group">
									                             <input class="form-control date-picker"  name="dob" type="text" id="dob"  />  
									                             <span class="input-group-addon">
																			<i class="fa fa-calendar bigger-110"></i>
																</span>
									                          </div>
								                           </div>
								                     </div>
										        </div> 
										   </div>
	                                  </div>
	                                  
	                                  
	                                   <div class="row">
		                                 <div class="col-sm-6" >
		                                      <div class="form-group">
								                          <label class="col-sm-2 control-label" i18n="personnel.emp.organization"></label>
								                           <div class="col-sm-8">
									                          <div class="input-group">
									                             <span class="input-group-btn">
									                             <button class="btn btn-default btn-white btn-grey"   id="clearOrg"   type="button">
									                             <i class="fa fa-times-circle red2"></i></button>
									                             </span>
									                             <input class="form-control "  readonly="readonly"  type="text" id="org"  />  
									                             <input   type="hidden"   name="organization.id"  id="organization_id"  /> 
									                             <span class="input-group-addon">
																			<i class="fa fa-list-alt bigger-110"  id="showOrgTree" ></i>
																</span>
									                          </div>
								                           </div>
								               </div>
		                                 </div>
		                                 <div class="col-sm-6" >
		                                      <div class="form-group">
								                          <label class="col-sm-2 control-label" i18n="personnel.emp.position"></label>
								                           <div class="col-sm-8">
									                          <div class="input-group">
									                             <span class="input-group-btn">
									                             <button class="btn btn-default btn-white btn-grey"   id="clearPos"   type="button">
									                             <i class="fa fa-times-circle red2"></i></button>
									                             </span>
									                             <input class="form-control " readonly="readonly"   name="pos" type="text" id="pos"  /> 
									                            
									                             <input   type="hidden"  name="position.id"  id="position_id"  />  
									                           
									                             <span class="input-group-addon">
																			<i class="fa fa-list-alt bigger-110"  id="showPosTree"></i>
																</span>
									                          </div>
								                           </div>
								               </div>
		                                 </div>
		                               </div>
	                                  
	                                  
	                                 <div class="row">
		                                 <div class="col-sm-12">
		                                      <div class="widget-header widget-header-large">
												<h3 class="widget-title grey lighter">
													<i class="ace-icon fa fa-leaf green"></i>
													<span i18n="personnel.emp.educationExperience"></span>
												</h3>
                                              </div>
                                              
		                                 </div>  
	                                 </div>
	                                 
								  </form>		
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer no-margin-top">
						<div class="text-center">
							
							<button id="submitEmployeeBtn"  class="btn btn-sm btn-primary">
							  <i class="ace-icon fa fa-floppy-o"></i>
							  <span i18n="save"></span>
							</button>
							
							<button class="btn btn-sm"  data-dismiss="modal">
							  <i class="ace-icon fa fa-share "></i>
							  <span i18n="cancel"></span>
							</button>
						</div>
					</div>
				</div><!-- /.modal-content -->
			
		</div><!-- /.modal-dialog -->
	</div>
	<div id="orgContent" class="orgContent widget-box widget-color-blue2 dropdown-menu" style="display:none;z-index:10160; ">
	      <ul id="orgTree" class="ztree" style="margin-top:0; width:160px;"></ul>
    </div>
	<div id="posContent" class="posContent widget-box widget-color-blue2 dropdown-menu" style="display:none;z-index:10160">
	      <ul id="posTree" class="ztree" style="margin-top:0; width:160px;"></ul>
    </div>
</div>



<script type="text/javascript">
var scripts = [ null, null ];
$('.page-content-area').ace_ajax('loadScripts', scripts, function() {
	var $container = $('#employee_container');
	var grid_selector  = "#employee_grid-table";
	var pager_selector = "#employee_grid-pager";
	var  employeeGrid = null;
	
	var lang = $.homeGlobal.LANG.replace('_',"-");
	var colNames;
	$.loy.i18n(['personnel/emp'],$.homeGlobal.LANG,$container,{custCallback:function(){
		$('input, textarea',$container).placeholder();
		colNames =[' ',
	               $.i18n.prop("personnel.emp.employeeNo"),
	               $.i18n.prop("personnel.emp.name"),
	               $.i18n.prop("personnel.emp.status"),
	               $.i18n.prop("personnel.emp.email"),
	               $.i18n.prop("personnel.emp.phone"),
	               $.i18n.prop("personnel.emp.dob"),
	               $.i18n.prop("personnel.emp.sex"),
	               $.i18n.prop("personnel.emp.organization")
	               
	               ]
	     
		createEmployeeGrid();
	}});
	
	$('.date-picker',$container).datepicker({
		autoclose: true,
		format : 'yyyy-mm-dd',
		language: 'zh-CN',
		todayHighlight: true
	}).next().on(ace.click_event, function(){
		$(this).prev().focus();
	});
	
	var $validateEmployeeForm = $('#employeeForm',$container).validate({
    	onsubmit:false,
    	rules : {
			name : {
				required : true,
			},
			email:{
				email : true
			}
		}
    });
	
	function edit (id){
		$('#employeeModalDiv',$container).modal("show");
		clearEmployeeForm();
		$('#submitEmployeeBtn',$container).attr("url","employee/update");
		$.loy.ajax({
			url:'employee/get',
			data:{id:id},
			success:function(data){
				var result = data.data;
				//$('#username').text(result.username?result.username:'');
				//$('#userStatus').text(result.userStatus?result.userStatus:'');
				$('#id',$container).val(result.id?result.id:'');
				$('#name',$container).val(result.name?result.name:'');
				$('#email',$container).val(result.email?result.email:'');
				$('#phone',$container).val(result.phone?result.phone:'');
				$('#sex',$container).val(result.sex?result.sex:'');
				var dob = result.dob?result.dob:''
				$('#dob',$container).val(dob.substring(0,10));
				if(result.organization){
					$('#org',$container).val(result.organization.name?result.organization.name:"");
					$('#organization_id',$container).val(result.organization.id?result.organization.id:"");
				}
				
				if(result.position){
					$('#pos',$container).val(result.position.name?result.position.name:"");
					$('#position_id',$container).val(result.position.id?result.position.id:"");
				}
				
			}
	});
	}
	function clearEmployeeForm(){
		$('#id',$container).val('');
		$('#name',$container).val('');
		$('#email',$container).val('');
		$('#phone',$container).val('');
		$('#sex',$container).val('');
		$('#dob',$container).val('');
		$('#org',$container).val("");
		$('#organization_id',$container).val("");
		$('#pos',$container).val("");
		$('#position_id',$container).val("");
		
	}
	function add(){
		clearEmployeeForm();
		$('#submitEmployeeBtn',$container).attr("url","employee/save");
		$('#employeeModalDiv',$container).modal("show");
	}
	
	function  createEmployeeGrid(){
		
		employeeGrid =jQuery(grid_selector).loyGrid({
			url: 'employee/page',
			datatype: "json",
			mtype: 'GET',
			colNames:colNames,
			colModel: [
			 {name:'myac',index:'', width:80, fixed:true, sortable:false, resize:false ,
				formatter:'actions', 
				formatoptions:getFormatoptions('employee/')
			 },
	   		{ name: 'employeeNo', index: 'employeeNo',width: 100, align: "left",editable: true,editrules:{required:true},
				 editoptions:{disabled:true}
	   		},
	   		{ name: 'name', index: 'name', width: 100, align: "left",editable: true }, 
	   		{ name: 'userStatus', index: 'userStatus', width: 60, align: "left",editable: true,
	   			formatter: "select", editoptions:{value:'NORMAL:正常状态;DISABLED:禁用状态'} },
	   		{ name: 'email', index: 'email', width: 100, align: "left",editable: true },
	   		{ name: 'phone', index: 'phone', width: 80, align: "left",editable: true },
	   		{ name: 'dob', index: 'dob', width: 100, align: "left",editable: true,formatter:'date', editoptions:{ctype:'date'}},
	   		{ name: 'sex', index: 'sex', width: 100, align: "left",editable: true ,formatter: "select",  editoptions:{value:'MALE:男;FEMALE:女'} },
	   		{ name: 'organization.name', index: 'organization.name', width: 100, align: "left",editable: false,formatter:function(cellvalue, options, rowObject){
	   			if(rowObject.organization){
	   				return rowObject.organization.name;
	   			}
	   			return "";
	   		} }
	   		],
			pager: pager_selector,
			loadComplete:function(data){
				loadComplete(data);
				var list = data.data?data.data.content:null;
				if(list){
					for(var i=0;i<list.length;i++){
						var editDivId = "jEditButton_"+list[i].id;
						$('#'+editDivId,employeeGrid).attr('onclick','').on('click',function(){
							edit($(this).closest('tr').attr('id'));
						});
					}
				}
			}
		}).loyGrid('navGrid','#employee_grid-pager',{"baseUrl":"employee/",
			"addfunc":function(){
				add();
			},
			"editfunc":function(rowId){
				edit(rowId);
			}
		});
		employeeGrid.jqGrid('setFrozenColumns');
		resizeToFitPage(employeeGrid);
	}
	
	$("#employeeSearchBtn").click(function(){
		var employeeNo = $("#employeeQueryParam_employeeNo",$container).val();
		var name = $("#employeeQueryParam_name",$container).val();
		var postData ={"employeeNo":employeeNo,"name":name,page:0};
		employeeGrid.loyGrid("setGridParam",{"postData":postData}).trigger("reloadGrid"); 
		
	});
	
	$('#submitEmployeeBtn',$container).click(function(){
		 if(!$validateEmployeeForm.checkForm()){
			$validateEmployeeForm.defaultShowErrors();
			return;
		 }
		 var url = $(this).attr("url");
		 $.loy.ajax({
				url:url,
				data:$("#employeeForm",$container).serialize(),
				success:function(data){
					if(data.success){
						$('#employeeModalDiv',$container).modal("hide");
						employeeGrid.trigger("reloadGrid");
					}
				}
		});
  });
	
	
	var orgSetting = {
			callback: {
				onClick: function(e, treeId, treeNode) {
					var zTree = $.fn.zTree.getZTreeObj("orgTree");
					var nodes = zTree.getSelectedNodes();
					var l = nodes[0].data;
					var orgObj = $("#org",$container);
					orgObj.val(l);
					$('#organization_id',$container).val( nodes[0].id);
			     }
			},
			
			data: {
				key:{
					title:"data",
					name:"data",
					checked: "selected"
					
				},
				simpleData: {
					enable: true,
				}
			}
	};
	
	$.loy.ajax({
		showSuccess:false,
        url: "org/all",
        success : function (data) { 
      	   var items = data.data;
      	   var $orgTree = $.fn.zTree.init($("#orgTree",$container), orgSetting, items);
      	   $orgTree.expandAll(true)
        },  
        error: function (response) {
             //console.log(response);  
        }
    }) ; 
	function hideMenu() {
		$("#orgContent",$container).fadeOut("fast");
		$("body").unbind("mousedown", onBodyDown);
	}
	function onBodyDown(event) {
		if (!(event.target.id == "showOrgTree" || event.target.id == "orgContent" || $(event.target).parents("#orgContent",$container).length>0)) {
			hideMenu();
		}
	}
	
	$('#showOrgTree',$container).on('click',function(){
		var orgObj = $("#org",$container);
		var orgOffset = orgObj.offset();
		$('.modal-body').offset().left;
		$("#orgContent",$container).css({left:orgOffset.left -$('.modal-dialog').offset().left +40 + "px",
			top:orgOffset.top -$('.modal-dialog').offset().top+ orgObj.outerHeight()-58 + "px"}).slideDown("fast");
		$("body").bind("mousedown", onBodyDown);
	});
	$('#clearOrg',$container).on('click',function(){
		$('#org',$container).val('');
		$('#organization_id',$container).val('');
	});
	
	
	
	
	var posSetting = {
			callback: {
				onClick: function(e, treeId, treeNode) {
					var zTree = $.fn.zTree.getZTreeObj("posTree");
					var nodes = zTree.getSelectedNodes();
					var l = nodes[0].data;
					var posObj = $("#pos",$container);
					posObj.val(l);
					$('#position_id',$container).val( nodes[0].id);
			     }
			},
			data: {
				key:{
					title:"data",
					name:"data"
				},
				simpleData: {
					enable: true,
				}
			}
	};
	
	$.loy.ajax({
		showSuccess:false,
        url: "position/all",
        success : function (data) { 
      	   var items = data.data;
      	   var $posTree = $.fn.zTree.init($("#posTree",$container), posSetting, items);
      	   $posTree.expandAll(true)
        }
    }) ; 
	function hidePosMenu() {
		$("#posContent",$container).fadeOut("fast");
		$("body").unbind("mousedown", onPosBodyDown);
	}
	function onPosBodyDown(event) {
		if (!(event.target.id == "showPosTree" || event.target.id == "posContent" || $(event.target).parents("#posContent",$container).length>0)) {
			hidePosMenu();
		}
	}
	
	$('#showPosTree',$container).on('click',function(){
		var posObj = $("#pos");
		var posOffset = posObj.offset();
		$('.modal-body').offset().left;
		$("#posContent",$container).css({left:posOffset.left -$('.modal-dialog',$container).offset().left +40 + "px",
			top:posOffset.top -$('.modal-dialog',$container).offset().top+ posObj.outerHeight()-58 + "px"}).slideDown("fast");
		$("body").bind("mousedown", onPosBodyDown);
	});
	$('#clearPos',$container).on('click',function(){
		$('#pos',$container).val('');
		$('#position_id',$container).val('');
	});
});

</script>
